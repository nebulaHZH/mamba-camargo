# 🚀 Mamba运动分类系统 - 使用说明

## ✨ 项目概述

这是一个基于最新Mamba(状态空间模型)架构的人体运动分类系统,能够准确识别4种运动类型。

### 🎯 支持的运动类型
- 🚶 **levelground** - 平地行走
- 🪜 **stair** - 楼梯行走  
- 🏃 **treadmill** - 跑步机
- ⛰️ **ramp** - 斜坡行走

### 📊 数据集信息
- **总样本数**: 70,167条
- **特征维度**: 196维(EMG肌电信号、加速度计、陀螺仪等传感器数据)
- **数据分布**:
  - treadmill: 33,597条 (47.9%)
  - ramp: 17,378条 (24.8%)
  - levelground: 12,589条 (17.9%)
  - stair: 6,603条 (9.4%)

## 📦 环境配置

### 方法1: 使用requirements.txt
```bash
pip install -r requirements.txt
```

### 方法2: 手动安装
```bash
pip install torch numpy pandas scikit-learn matplotlib seaborn tqdm openpyxl
```

## 🔧 快速开始

### Step 1: 验证环境
首先运行测试脚本,确保所有依赖正确安装:

```bash
python test_setup.py
```

你会看到:
```
============================================================
快速测试 - 验证系统配置
============================================================

1. 测试数据加载...
✓ 数据加载成功!

2. 测试模型初始化...
✓ 模型初始化成功!
  设备: cpu
  参数量: 746,948

3. 测试前向传播...
✓ 前向传播成功!

============================================================
✓ 所有测试通过! 系统配置正确,可以开始训练。
============================================================
```

### Step 2: 训练模型
运行主程序开始训练:

```bash
python main.py
```

训练过程中你会看到:
- 📊 数据加载和预处理信息
- 📈 每个epoch的训练/验证损失和准确率
- 💾 最佳模型自动保存
- 🎨 训练历史和混淆矩阵自动生成

训练完成后会生成:
- `best_model.pth` - 最佳模型检查点
- `training_history.png` - 训练历史曲线图
- `confusion_matrix.png` - 混淆矩阵热力图

### Step 3: 使用模型预测

#### 方法A: 从文件批量预测
```python
from inference import ActivityPredictor

# 初始化预测器
predictor = ActivityPredictor('best_model.pth')

# 批量预测
results = predictor.predict_from_csv('data.csv', 'predictions.csv')
```

#### 方法B: 单个样本预测
```python
from inference import ActivityPredictor
import pandas as pd

# 初始化预测器
predictor = ActivityPredictor('best_model.pth')

# 读取一个样本
df = pd.read_excel('data.csv', nrows=1)
sample = df.iloc[0, :-3].values  # 提取特征(前196列)

# 预测
predictions, probabilities = predictor.predict(sample)

print(f"预测结果: {predictions[0]}")
print(f"\n各类别概率:")
for i, class_name in enumerate(predictor.label_encoder.classes_):
    print(f"  {class_name}: {probabilities[0, i]*100:.2f}%")
```

## 🏗️ 模型架构

### Mamba核心特点
- ⚡ **线性复杂度**: O(n),比Transformer的O(n²)更快
- 🎯 **选择性机制**: 动态选择重要特征
- 🔄 **状态空间模型**: 高效建模时序依赖

### 网络结构
```
输入(196维) 
  ↓
嵌入层(196 → 128)
  ↓
4层Mamba残差块
  ├─ LayerNorm
  ├─ MambaBlock
  │   ├─ 输入投影
  │   ├─ 1D卷积
  │   ├─ SSM状态更新
  │   ├─ 门控机制
  │   └─ 输出投影
  └─ Dropout + 残差连接
  ↓
全局平均池化
  ↓
分类头(128 → 64 → 4)
  ↓
输出(4类概率)
```

### 模型参数
| 参数 | 值 | 说明 |
|------|-----|------|
| d_model | 128 | 模型隐藏维度 |
| n_layers | 4 | Mamba层数 |
| d_state | 16 | 状态空间维度 |
| d_conv | 4 | 卷积核大小 |
| expand | 2 | 内部扩展因子 |
| dropout | 0.1 | Dropout比率 |
| **总参数量** | **746,948** | - |

## ⚙️ 训练配置

### 默认配置
```python
config = {
    'batch_size': 64,           # 批次大小
    'num_epochs': 50,           # 最大训练轮数
    'learning_rate': 0.001,     # 学习率
    'test_size': 0.2,           # 测试集比例(20%)
    'val_size': 0.1,            # 验证集比例(10%)
}
```

### 优化策略
- **优化器**: AdamW(权重衰减=0.01)
- **学习率调度**: CosineAnnealingLR
- **早停**: 10个epoch验证准确率无提升则停止
- **损失函数**: CrossEntropyLoss

## 📈 性能指标

训练完成后会输出:
- ✅ 训练/验证准确率曲线
- ✅ 训练/验证损失曲线  
- ✅ 测试集准确率
- ✅ 详细分类报告(Precision, Recall, F1-score)
- ✅ 混淆矩阵

示例输出:
```
测试集结果:
Loss: 0.1234
Accuracy: 95.67%

分类报告:
              precision    recall  f1-score   support

  levelground     0.9523    0.9456    0.9489      2518
        ramp     0.9612    0.9587    0.9599      3476
       stair     0.9301    0.9412    0.9356      1321
   treadmill     0.9678    0.9723    0.9700      6719

    accuracy                         0.9567     14034
```

## 🎛️ 自定义配置

### 调整模型大小
```python
# 在main.py中修改config
config = {
    'd_model': 256,      # 增加到256(更大的模型)
    'n_layers': 6,       # 增加到6层(更深)
    'batch_size': 32,    # 减小批次(节省内存)
}
```

### 调整训练策略
```python
config = {
    'learning_rate': 0.0005,  # 降低学习率
    'num_epochs': 100,        # 增加训练轮数
    'test_size': 0.15,        # 调整数据集划分
}
```

## 📁 文件说明

```
mamba/
├── data.csv                 # 数据集(Excel格式,70167条样本)
├── main.py                  # 主训练脚本(520行)
├── inference.py             # 推理脚本(154行)
├── test_setup.py            # 环境测试脚本
├── requirements.txt         # 依赖列表
├── README.md                # 英文文档
├── 使用说明.md              # 中文文档(本文件)
├── best_model.pth          # 训练后生成:最佳模型
├── training_history.png    # 训练后生成:训练曲线
└── confusion_matrix.png    # 训练后生成:混淆矩阵
```

## 🔍 常见问题

### Q1: 训练很慢怎么办?
A: 如果有GPU,确保安装CUDA版本的PyTorch:
```bash
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118
```

### Q2: 内存不足怎么办?
A: 减小批次大小:
```python
config['batch_size'] = 32  # 或更小的值
```

### Q3: 如何提高准确率?
A: 尝试:
- 增加模型大小(d_model, n_layers)
- 增加训练轮数
- 调整学习率
- 使用数据增强

### Q4: data.csv为什么是Excel格式?
A: 文件虽然后缀是.csv,但实际是Excel(.xlsx)格式,代码已自动处理,无需担心。

## 🎓 技术细节

### Mamba vs Transformer
| 特性 | Mamba | Transformer |
|------|-------|-------------|
| 时间复杂度 | O(n) | O(n²) |
| 内存占用 | 低 | 高 |
| 长序列处理 | 优秀 | 受限 |
| 训练速度 | 快 | 慢 |

### 数据预处理流程
1. 读取Excel数据
2. 分离特征(前196列)和标签(activity_type)
3. 标签编码(LabelEncoder)
4. 特征标准化(StandardScaler)
5. 数据集划分(70% train, 10% val, 20% test)

## 📞 支持

如有问题,请检查:
1. ✅ 运行`test_setup.py`确认环境配置
2. ✅ 确保数据文件`data.csv`在正确位置
3. ✅ 查看生成的训练日志

## 📝 许可证

MIT License - 自由使用和修改

---

**祝训练愉快! 🎉**
