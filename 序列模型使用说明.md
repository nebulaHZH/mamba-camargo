# 基于真实时序数据的Mamba模型训练

## 📊 数据结构

你的数据集结构：
```
E:\0_yao\dataset\carmago_struct\
├── AB06\
│   ├── 10_09_18\
│   │   ├── levelground\
│   │   │   └── emg\
│   │   │       └── levelground_ccw_fast_01_01.mat
│   │   ├── stair\
│   │   ├── treadmill\
│   │   └── ramp\
│   └── ...
├── AB07\
└── ...
```

**Mat文件内容：**
- `data_struct`: 形状 (时间步数, 1)，包含11个EMG通道
  - gastrocmed (腓肠肌内侧头)
  - tibialisanterior (胫骨前肌)
  - soleus (比目鱼肌)
  - vastusmedialis (股内侧肌)
  - vastuslateralis (股外侧肌)
  - rectusfemoris (股直肌)
  - bicepsfemoris (股二头肌)
  - semitendinosus (半腱肌)
  - gracilis (股薄肌)
  - gluteusmedius (臀中肌)
  - rightexternaloblique (右腹外斜肌)

## 🎯 核心思路

### 与之前的区别

**之前 (main.py)：**
- 输入：时频域特征 (batch, feature_dim)
- 问题：已经是统计特征，丢失了时序信息
- Mamba优势：无法发挥

**现在 (train_mamba_sequence.py)：**
- 输入：原始EMG时序 (batch, seq_len, channels)
- 数据：真正的时间序列信号
- Mamba优势：充分发挥序列建模能力

### 数据处理流程

```
Mat文件 → 提取11通道EMG信号 (T, 11)
         ↓
    滑窗切分 (window_size=500, stride=250)
         ↓
    多个窗口样本 (500, 11)
         ↓
    标准化 (按通道)
         ↓
    送入Mamba模型
```

## 🚀 使用方法

### 1. 快速测试数据加载

```bash
python test_data_loading.py
```

这会加载每个类别的前2个文件，验证数据加载是否正常。

### 2. 完整训练

```bash
python train_mamba_sequence.py
```

或者双击运行：
```bash
train_sequence.bat
```

### 3. 关键参数配置

在 `train_mamba_sequence.py` 的 `config` 中：

```python
config = {
    'window_size': 500,      # 窗口大小（时间步数）
    'stride': 250,           # 滑窗步长（50%重叠）
    'batch_size': 32,        # 批次大小
    'num_epochs': 50,        # 训练轮数
    'learning_rate': 0.001,  # 学习率
    'd_model': 128,          # 模型维度
    'n_layers': 4,           # Mamba层数
    'dropout': 0.2,          # Dropout率
    'max_files_per_class': None,  # 快速测试时设为2，完整训练设为None
}
```

## 📈 输出结果

训练完成后会生成：

1. **best_model_seq.pth** - 最佳模型权重
2. **training_history_seq.png** - 训练曲线图
3. **confusion_matrix_seq.png** - 混淆矩阵
4. 控制台输出详细的分类报告

## 🔧 调优建议

### 如果准确率不理想：

1. **增加窗口大小**
   ```python
   'window_size': 1000  # 更长的上下文
   ```

2. **调整模型容量**
   ```python
   'd_model': 256,    # 更大的模型
   'n_layers': 6,     # 更多层
   ```

3. **数据增强**
   - 可以添加噪声
   - 时间拉伸/压缩
   - 幅度缩放

4. **调整学习率**
   ```python
   'learning_rate': 0.0005  # 更小的学习率
   ```

### 如果训练太慢：

1. **减小窗口大小**
   ```python
   'window_size': 300
   ```

2. **减少模型复杂度**
   ```python
   'd_model': 64,
   'n_layers': 2,
   ```

3. **增大步长**
   ```python
   'stride': 500  # 无重叠
   ```

## 💡 与特征版本对比

你现在有两个版本可以对比：

| 特性 | main.py (特征版) | train_mamba_sequence.py (序列版) |
|------|-----------------|--------------------------------|
| 输入 | 时频域特征向量 | 原始EMG时序信号 |
| 形状 | (batch, feature_dim) | (batch, seq_len, channels) |
| Mamba作用 | 受限（伪序列） | 充分发挥 |
| 训练速度 | 快 | 较慢 |
| 理论效果 | 一般 | 更好 |

建议：**两个都跑一遍，对比效果！**

## 📝 数据集统计

根据测试结果：
- 总文件数：5997个
- levelground: 1294个文件
- stair: 1741个文件
- treadmill: 299个文件
- ramp: 2663个文件

**注意**：类别不平衡，可能需要：
- 使用类别权重
- 过采样少数类
- 欠采样多数类

## ❓ 常见问题

**Q: 内存不足怎么办？**
A: 减小 `batch_size` 或 `window_size`

**Q: 训练时间太长？**
A: 先设置 `max_files_per_class=10` 快速验证，确认代码无误后再全量训练

**Q: 想要使用GPU加速？**
A: 代码已自动检测GPU，确保PyTorch安装了CUDA版本即可

**Q: 如何保存预测结果？**
A: 可以在evaluate函数中添加保存逻辑，将预测结果写入CSV

## 🎓 理论说明

**为什么这样做更适合Mamba？**

Mamba是状态空间模型（SSM），其核心优势是：
1. **长序列建模**：能有效捕捉长距离依赖
2. **线性复杂度**：相比Transformer更高效
3. **时序特征提取**：自动学习时序模式

你的EMG信号是典型的时序数据，每个时间步包含11个通道的肌肉活动信息。Mamba可以：
- 学习不同肌肉之间的协同模式
- 捕捉运动过程中的时序演变
- 自动提取判别性时序特征

而时频域特征是**人工设计**的统计量，虽然包含了有用信息，但丢失了很多时序细节。

## 🔄 下一步

1. ✅ 数据加载测试通过
2. ⏳ 运行完整训练
3. ⏳ 查看结果并调优
4. ⏳ 与特征版本对比
5. ⏳ 尝试其他模型（LSTM/Transformer）对比
